language: elixir
sudo:     false

env:
  global:
    - MIX_ENV=test
  matrix:
      # dfb9939d == nearest (buildable) commit to release v0.4.1
    - VER_CAYLEY=dfb9939d

before_install:
  - mkdir "${HOME}/go"
  - export GOPATH="${HOME}/go"
  - export PATH="${GOPATH}/bin:${PATH}"
  - mkdir -p "${GOPATH}/src/github.com/google"
  - cd "${GOPATH}/src/github.com/google"
  - wget -q "https://github.com/google/cayley/archive/${VER_CAYLEY}.tar.gz" -O cayley.tar.gz && tar -xf cayley.tar.gz
  - find . -maxdepth 1 -type d -name 'cayley*' -exec mv {} cayley \;
  - cd "${GOPATH}/src/github.com/google/cayley"
  - git init .
  - go get github.com/tools/godep
  - godep restore
  - go build ./cmd/cayley
  - go install ./cmd/cayley
  - cd "${TRAVIS_BUILD_DIR}"

before_script:
  - cayley http --db=memstore --dbpath="" &

after_success:
  - mix coveralls.travis

after_script:
  - ps | grep 'cayley' | grep -v 'grep' | awk '{ print $1 }' | xargs kill
